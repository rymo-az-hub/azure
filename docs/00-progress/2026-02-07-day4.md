# Day 4 Progress (2026-02-07)

## 今日の結論

- **方針は A で進める**（what-if 結果を見て、想定外の大きな差分がないことを確認できたため）
- 今日はここで一旦区切り（コミット/Push まで完了）

---

## 今日やったこと（サマリ）

### 1) Repo整理（infra/kv 再編）

- `infra/kv` 配下を **baseline-v1 を正本**に統一
- 旧構成（`pe-v1` / `rbac-v2` / 旧 keyvault）は `infra/kv/_legacy/` に集約
- `infra/kv/README.md` を追加し、導線を整理
- 追加された構成（最終状態）
  - `infra/kv/baseline-v1/`（modules: keyvault / privateDns / privateEndpoint / diagnostics / rbac）

### 2) Docs更新（Evidence / 進捗 / コマンドログ / ADR）

- Evidence を更新（kv RBAC v2）
- 進捗ログとコマンドログを更新
- ADR を追加（KV RBAC v2 の最小権限・主体分離）

### 3) Git運用（CRLF/LFで詰まった点の解消）

- `git add` 時に **CRLF → LF 置換が発生するファイル**があり、staging が止まった
- PowerShell で **CRLF→LF 正規化**してから add（README系）

---

## Azure側の確認（what-if）

実施コマンド（例）:

- `az deployment group what-if -g $rg -f $f -p @$p`

what-if の主な差分（読み取り）:

- **変更は 2 件のみ（Modify）**
  1. Diagnostic settings: `AzurePolicyEvaluationDetails` の logs 設定周り（ノイズ含む）
  2. Private Endpoint の `privateDnsZoneGroups` の `privateDnsZoneConfigs` 表示差分（etag / provisioningState / type などの **ノイズ**）

---

## 判断理由（Aでいく根拠）

- what-if の差分が **意図した構成（baseline-v1）に沿う範囲**で、破壊的変更がない
- `privateDnsZoneGroups` の差分は ARM の **読み取り差（ノイズ）**が主で、資産の再作成や構成破綻の兆候なし
- Diag 周りも “勝手に大量変更” ではなく、カテゴリ設定差分の範囲

---

## 次回やること（具体）

1. baseline-v1 を実デプロイ（WhatIf → Deploy）
2. Deploy後の Evidence を追加
   - KV 本体設定（soft delete / purge protection / public network access / firewall / RBAC / purge保護）
   - PE / DNS（疎通、名前解決、NIC/PEサブリソース）
   - Diagnostic settings（LAW到達・カテゴリ）
3. `main.parameters.json` のパラメータ妥当性（RBAC主体・タグ）を最終確認して固定

---

## メモ

- parameters（例）
  - `location`: japaneast
  - `keyVaultName`: kv-plat-dev-45bddcd7-001
  - `logAnalyticsWorkspaceId`: law-platform-baseline
  - `vnetId` / `privateEndpointSubnetId`: vnet-platform-baseline / snet-privatelink
  - RBAC: `secretsOfficers` / `secretsUsers` を GUID で指定
