# Day 2 Progress (2026-02-01)

## Goal (6 months)
Azure特化企業（MSパートナー含む）向けに、Platform / Landing Zone / IaC / 運用設計寄りの実績を個人環境で作る。

## Summary (What was achieved today)
- Cost Management Budget（Subscription scope）を IaC（Bicep）で作成し、閾値通知（80% / 100%）まで含めて動作確認
- Subscription Activity Log → Log Analytics のログ基盤を IaC（Bicep）で構築
  - Log Analytics workspace を新規作成（RG含む）し、診断設定 `ds-activitylog-to-law` を作成
  - Log Analytics（KQL）で `AzureActivity` の流入を確認し、証跡を取得
- `policy-baseline.md` に、上記（Budget / ActivityLog→LAW）の Evidence を追記して “成果物として一連の流れ” を完成

---

## Timeline (What I did, including failures)

### 0. Repo/Docs 整理
- `docs/02-governance/policy-baseline.md` を更新し、Evidence を追記できる構造（セクション/フォーマット）を維持

### 1. Budget v1 (IaC) の実装・適用
- `infra/platform/cost/budget.bicep` を配置してサブスクスコープでデプロイ
- what-if で作成対象を確認後に create を実行し、`Succeeded` を確認
- `az consumption budget show` で Budget の生成を確認（通知先メール・閾値 80/100）

#### Failure -> Fix
- 初回は Bicep の構文エラーや未使用パラメータ等が出たため修正
- `contactEmails` を配列で渡す JSON パースに詰まり、最終的に **単一メール `contactEmail`** パラメータに整理して解決

### 2. Activity Log → Log Analytics (IaC) の実装・適用
- `infra/platform/monitoring/activitylog-to-law.bicep` と `log-analytics.bicep` を配置
- Subscription scope で RG を作成し、RG scope module で Log Analytics workspace を作成
- Subscription scope に `Microsoft.Insights/diagnosticSettings` を作成し、workspace に紐づけ

#### Failure -> Fix (Bicep scope / module)
- Subscription scope の Bicep 内で RG scope リソース（workspace）を `scope:` 付き resource として書いてしまい失敗
  - エラー: BCP037 / BCP139（ファイルスコープ不一致）
- **RG scope は module で切り出す**構成に変更して解決

#### Failure -> Fix (tags JSON / PowerShell)
- Policy Baseline の「必須タグ（Owner/CostCenter/Environment）」に合わせ、`tags` を必ず付与する必要がある
- PowerShell で `tags='{"Owner":"..."}'` が JSON として解釈されず失敗するケースがあり、
  - 一時パラメータファイル `tmp-monitoring-tags.json` を作成して `--parameters .\tmp-monitoring-tags.json` で渡す方式に変更し解決

### 3. Log の流入確認（Portal / KQL）
- Log Analytics（Logs）で KQL を実行し、`AzureActivity` にデータが入っていることを確認
  - 初期は 0 件が続いたが、時間経過後に出力が確認できた
- KQL（Evidence 用）を `policy-baseline.md` に追記

---

## Artifacts (what exists in the repo)
- docs/02-governance/policy-baseline.md
  - Budget（IaC）/ Activity Log→LAW（IaC）の Evidence を追加
- infra/platform/cost/budget.bicep
  - Subscription budget（80/100通知）を作成
- infra/platform/monitoring/activitylog-to-law.bicep
  - Subscription 診断設定（Activity Log→LAW） + RG/Workspace 作成（module 呼び出し）
- infra/platform/monitoring/log-analytics.bicep
  - Log Analytics workspace（RG scope）

## Notes / Learnings
- 개인環境では MG 権限が無い前提があり、**subscription scope で “実務に近いベースライン” を作る**戦略が現実的
- PowerShell で JSON/配列を渡す系は事故りやすいので、**一時パラメータファイル**は再現性が高い
- “設定はあるのにログが見えない” は起こり得る（遅延・UIモード等）。証跡は CLI/REST/Portal の複線で取ると強い

## Next (planned)
- （運用寄りの次打ち手）Key Vault baseline（ネットワーク/保護設定/診断設定）を IaC + Evidence
- （LZ寄りの次打ち手）Policy baseline v2（VM SKU制限など）を Initiative に増強
