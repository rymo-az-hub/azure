# Day 5 Progress (2026-02-08)

## 今日の結論

- **PrivateLink 経由の KV 到達性（DNS / 443）と RBAC v2（Read OK / Write NG）を証跡化できた**
- Evidence を `docs/evidence/kv/rbac-v2/` に配置し、README 導線を整備して **Commit / Push 完了**
- 一時VM（`vmkvdev02`）と関連リソース（NIC / NSG / Disk）を削除し、`rg-platform-baseline` は **baseline に必要なリソースのみ残存**（PE NIC など）

---

## 今日やったこと（サマリ）

### 1) 一時VM作成（Public IP なし）→ PrivateLink 疎通確認

- 目的: PrivateLink 経由で KV に到達できることを VM 内から検証する
- VM: `vmkvdev02`（`rg-platform-baseline` / `snet-workload` / Private IP: `10.10.2.4`）
- `japaneast` の Capacity Restrictions により、以下 SKU が `SkuNotAvailable` で失敗
  - `Standard_B2s`
  - `Standard_D2s_v5`
  - `Standard_D2as_v5`
- 回避: **`Standard_D2s_v4` で VM 作成成功**
- VM 内で以下を確認
  - `nslookup <kv>.vault.azure.net` が `privatelink.vaultcore.azure.net` に CNAME し、PE の IP（`10.10.1.4`）に解決される
  - `Test-NetConnection <kv>.vault.azure.net -Port 443` が成功（RemoteAddress: `10.10.1.4`）

### 2) VM 内で RBAC v2（最小権限）の検証（Az PowerShell）

- VM 内に `az` が存在しないため、Az PowerShell を導入して検証を継続
- `Connect-AzAccount -UseDeviceAuthentication` でサインインし、対象 Subscription を設定
- Read（成功）
  - `Get-AzKeyVaultSecret -VaultName kv-plat-dev-45bddcd7-001` が成功
- Write（失敗）
  - `Set-AzKeyVaultSecret ...` が `Forbidden`
  - エラーに `Action: Microsoft.KeyVault/vaults/secrets/setSecret/action` と `Assignment: (not found)` を確認
  - → **ネットワークではなく RBAC により Write が拒否**されることを証跡化

### 3) Role Assignment の裏取り（Key Vault スコープ）

- `Get-AzRoleAssignment -Scope <kvResourceId>` で KV スコープの割当を一覧化
- 対象ユーザー（`avd@...` / `oid=eeb850f4-...`）に `Key Vault Secrets User` が付与されていることを確認（Read OK の根拠）
- `Owner` も同一 ObjectId で見えるが、今回の Write 試行は `Assignment: (not found)` であり、**setSecret/action を許可する割当が無い**ことがエラーで確認できる

---

## 判断理由（Aでいく根拠）

- ローカルPCからは `ForbiddenByConnection` が確認できており、`publicNetworkAccess=Disabled` による **Public 経路遮断は期待どおり**
- VM 内の DNS 解決と 443 到達が PE の IP に対して成立しており、**PrivateLink 経由の到達性が成立**
- Write の失敗が `setSecret/action` と `Assignment: (not found)` で説明できるため、**RBAC 最小権限（Read OK / Write NG）の証跡として十分**

---

## 成果物（Repo反映）

- Repo: `azure`（`C:\Users\Ryosuke.M\source\repos\azure`）
- 追加:
  - `docs/evidence/kv/rbac-v2/2026-02-08-privatelink-rbac-readok-writeforbidden.md`
  - `docs/evidence/kv/rbac-v2/README.md`
- 更新:
  - `docs/evidence/README.md`
- Commit:
  - `docs(evidence): add kv rbac-v2 privatelink/read-write evidence`（`7020332`）

---

## クリーンアップ（検証用リソース削除）

- 削除済み:
  - VM: `vmkvdev02`（存在しないことを `az vm show` の `ResourceNotFound` で確認）
  - NIC: `vmkvdev02-nic`
  - NSG: `vmkvdev02-nsg`
  - Disk: `vmkvdev02_OsDisk_...`（孤児化して残っていたため削除）
- `rg-platform-baseline` の残存リソース（期待どおり）
  - `law-platform-baseline`
  - `kv-plat-dev-45bddcd7-001`
  - `privatelink.vaultcore.azure.net`（Private DNS Zone）
  - `privatelink.vaultcore.azure.net/link-...`（VNet link）
  - `pe-kv-plat-dev-45bddcd7-001`
  - `pe-kv-plat-dev-...nic...`（PE NIC）
  - `mi-kv-secrets-officer-dev`

---

## 次回やること（具体）

1. baseline-v1 を実デプロイ（WhatIf → Deploy）

---

## あなたへのルール

- 私の一人称は「私」とする
- 敬語を使う（私も敬語を使います）
- 作成したファイルは文字化けしていないか確認する
- 文字化けしていた場合は修正する
- リポジトリを把握する
- リポジトリを忘れた場合は確認する
- 進め方は推奨されるものを順番に一つずつやっていく
- 一度に複数の工程を出さない（追加で～は無しで、今やることをやってから追加をやるか聞く）
- `$repoRoot = (Get-Location).Path` → `Join-Path` で絶対パスを癖にする
- マシンサイズは要件がなければ「Standard_D2s_v4」を使う
