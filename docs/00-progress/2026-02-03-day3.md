# Day 3 Progress (2026-02-03)

## Goal (6 months)
Azure特化企業（MSパートナー含む）向けに、Platform / Landing Zone / IaC / 運用設計寄りの実績を個人環境で作る。

## Summary (What was achieved today, incl. yesterday work)
- Key Vault を Private Endpoint 前提で利用できること（DNS/到達性）を VM から確認し、Evidence を取得
- Key Vault を Azure RBAC（最小権限）で操作できることを、**主体分離（Officer / User）**で検証し Evidence を取得
  - Officer（avd@...）: Secret `set/get` 成功
  - Secrets User（kvsecretsuser01@...）: Secret `get` 成功 / `set` は Forbidden（最小権限差分）
- Bastion が Public IP deny ポリシーで作れない問題に対し、**initiative 参照 1点のみ（denyResourceTypes-publicip）を RG スコープで Exemption**して最小緩和→Bastion 作成→VM に入って検証を完遂
- 検証完了後、**コスト最適化**として Bastion / Public IP / Exemption / 追加ユーザー / VM / 残骸（NIC/NSG/Disk）を削除し、環境を最小構成に整理
- Key Vault の診断設定（LAW 送信）も一旦削除し、LAW の usage が 0 Bytes であることを確認（コスト抑制）

---

## Timeline (What I did, including failures)

### 1. Bastion 作成の障害（Public IP deny）→最小緩和で解決
- Bastion を Portal/CLI で作成しようとしたが、Public IP が Policy deny で失敗（RequestDisallowedByPolicy）
- subscription に initiative `ps-platform-baseline-v1` が割当済みであることを確認
- `rg-network-baseline` スコープで `denyResourceTypes-publicip` のみを対象に Policy Exemption を作成（期限付き）
- Exemption 後、Public IP → AzureBastionSubnet → Bastion（Standard）作成に成功し、VM へ接続可能になった

### 2. VM から Private Endpoint 経由で KV 到達性を確認
- `nslookup kv-plat-dev-...vault.azure.net` が privatelink に解決され、A レコードが PE の Private IP（10.10.1.4）となることを確認
- `Test-NetConnection -Port 443` で RemoteAddress=10.10.1.4 / TcpTestSucceeded=True を確認

### 3. RBAC v2 の操作検証（最小権限差分）
#### Failure -> Fix（Forbidden / Assignment not found）
- VM 上で `Get-AzKeyVaultSecret / Set-AzKeyVaultSecret` が Forbidden
- エラーに出た `oid=...` と、KV スコープの RoleAssignment の `principalId` が一致しないことを確認
- 原因：VM 側でログインしているアカウント（oid）が、RBAC を付与したアカウントと別だった
- VM 側の `Connect-AzAccount -UseDeviceAuthentication` をやり直し、`Get-AzContext` で Account を揃えて解決

#### 主体分離（差分 Evidence のための追加ユーザー）
- 追加ユーザー `kvsecretsuser01@...` を作成し、KV スコープに `Key Vault Secrets User` のみ付与
- VM 上でそのユーザーに切り替え、`Get` 成功 / `Set` Forbidden を取得（最小権限差分の証跡）

### 4. コスト観点のクリーンアップ
- Bastion / Public IP / Policy Exemption / 追加ユーザーを削除
- VM を削除後、残りやすい NIC/NSG/Managed Disk を確認して削除
- `kvplatbaselinedev001` が別 Key Vault であることを特定し、不要なため削除
- LAW usage を確認し 0 Bytes。KV の diag-to-law も削除し、取り込み停止

---

## Artifacts (what exists in the repo)
- docs/evidence/kv-rbac-v2-evidence.md
  - Private Endpoint 経由の DNS/443 到達性、RBAC 最小権限（Officer/User差分）手順を整理
- （必要に応じて）infra/kv/...（RBAC/PE 関連の Bicep など）

## Notes / Learnings
- RBAC の Forbidden はまず「**Caller oid と RoleAssignment principalId の一致**」を最優先で確認する（ここがズレると何をやっても通らない）
- Bastion を “例外 1点のみ” で通すには、initiative の `policyDefinitionReferenceId` を特定し、RG スコープで Exemption するのが最小緩和
- VM 削除後は **Disk/NIC/NSG が残る**ことが多い。リソース一覧で残骸を消し切るまでがコスト最適化
- LAW は PerGB なので、検証停止時は診断設定を削除して取り込みを止めるのが確実

## Next (planned)
- Key Vault baseline を IaC 化（ネットワーク/保護設定/診断設定の標準化）
- Evidence のテンプレ化（“RBAC検証は主体分離” を標準手順として固定）
