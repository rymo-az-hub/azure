{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "4910278233866546301"
    }
  },
  "parameters": {
    "createLogAnalytics": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Whether to create a new Log Analytics workspace (true) or use an existing workspaceId (false)."
      }
    },
    "logAnalyticsRgName": {
      "type": "string",
      "defaultValue": "rg-platform-monitoring",
      "metadata": {
        "description": "Resource group name for Log Analytics (only used when createLogAnalytics = true)."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "japaneast",
      "allowedValues": [
        "japaneast",
        "japanwest"
      ],
      "metadata": {
        "description": "Location for Log Analytics resources (must be within allowed locations baseline)."
      }
    },
    "logAnalyticsWorkspaceName": {
      "type": "string",
      "defaultValue": "law-platform-baseline",
      "metadata": {
        "description": "Log Analytics workspace name (only used when createLogAnalytics = true)."
      }
    },
    "retentionInDays": {
      "type": "int",
      "defaultValue": 30,
      "minValue": 30,
      "maxValue": 730,
      "metadata": {
        "description": "Workspace retention in days (30-730)."
      }
    },
    "existingWorkspaceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing Log Analytics workspace resourceId (required when createLogAnalytics = false)."
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "Owner": "Ryosuke",
        "CostCenter": "000",
        "Environment": "dev"
      },
      "metadata": {
        "description": "Tags required by the baseline (Owner/CostCenter/Environment)."
      }
    },
    "activityLogDiagName": {
      "type": "string",
      "defaultValue": "ds-activitylog-to-law",
      "metadata": {
        "description": "Diagnostic settings name for Activity Log."
      }
    }
  },
  "variables": {
    "workspaceIdGuard": "[if(and(not(parameters('createLogAnalytics')), empty(parameters('existingWorkspaceId'))), 'ERROR: existingWorkspaceId is required when createLogAnalytics=false', 'OK')]"
  },
  "resources": [
    {
      "condition": "[parameters('createLogAnalytics')]",
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[parameters('logAnalyticsRgName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]"
    },
    {
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "name": "[parameters('activityLogDiagName')]",
      "properties": {
        "logAnalyticsDestinationType": "Dedicated",
        "workspaceId": "[if(parameters('createLogAnalytics'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('logAnalyticsRgName')), 'Microsoft.Resources/deployments', format('law-{0}', parameters('logAnalyticsWorkspaceName'))), '2025-04-01').outputs.workspaceId.value, parameters('existingWorkspaceId'))]",
        "logs": [
          {
            "category": "Administrative",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          },
          {
            "category": "Security",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          },
          {
            "category": "ServiceHealth",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          },
          {
            "category": "Alert",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          },
          {
            "category": "Recommendation",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          },
          {
            "category": "Policy",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          },
          {
            "category": "Autoscale",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          },
          {
            "category": "ResourceHealth",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          }
        ],
        "metrics": []
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('logAnalyticsRgName')), 'Microsoft.Resources/deployments', format('law-{0}', parameters('logAnalyticsWorkspaceName')))]"
      ]
    },
    {
      "condition": "[parameters('createLogAnalytics')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('law-{0}', parameters('logAnalyticsWorkspaceName'))]",
      "resourceGroup": "[parameters('logAnalyticsRgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[parameters('logAnalyticsWorkspaceName')]"
          },
          "retentionInDays": {
            "value": "[parameters('retentionInDays')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "18085402217810476209"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for Log Analytics workspace."
              }
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace name."
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 30,
              "minValue": 30,
              "maxValue": 730,
              "metadata": {
                "description": "Workspace retention in days (30-730)."
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags required by the baseline (Owner/CostCenter/Environment)."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[parameters('logAnalyticsWorkspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "retentionInDays": "[parameters('retentionInDays')]",
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                }
              }
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
            },
            "workspaceCustomerId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2022-10-01').customerId]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('logAnalyticsRgName'))]"
      ]
    }
  ],
  "outputs": {
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "value": "[if(parameters('createLogAnalytics'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('logAnalyticsRgName')), 'Microsoft.Resources/deployments', format('law-{0}', parameters('logAnalyticsWorkspaceName'))), '2025-04-01').outputs.workspaceId.value, parameters('existingWorkspaceId'))]"
    },
    "diagnosticSettingsId": {
      "type": "string",
      "value": "[subscriptionResourceId('Microsoft.Insights/diagnosticSettings', parameters('activityLogDiagName'))]"
    },
    "workspaceIdGuard": {
      "type": "string",
      "value": "[variables('workspaceIdGuard')]"
    }
  }
}